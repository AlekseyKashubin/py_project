(()=>{var t={996:t=>{(()=>{"use strict";var e,a={};e=a,Object.defineProperty(e,"__esModule",{value:!0}),e.SHOPIFY_API_KEY=e.DEVELOPMENT_PATH_PREFIX=e.GEOSERVICE_URL=e.APP_URL=e.NODE_ENV=void 0,e.NODE_ENV="production",e.APP_URL="https://skosm.klarna.com",e.GEOSERVICE_URL=`${e.APP_URL}/geolocation/v1`,e.DEVELOPMENT_PATH_PREFIX="",e.SHOPIFY_API_KEY="4439684aa13a71f0befb66b3a308e7d4",t.exports=a})()}},e={};function a(n){var i=e[n];if(void 0!==i)return i.exports;var r=e[n]={exports:{}};return t[n](r,r.exports,a),r.exports}(()=>{"use strict";const t=(...t)=>{console.log("[klarna-osm]",...t)},e=t=>new Promise((e=>setTimeout(e,t)));var n=a(996);const i={"Europe/Vienna":"AT","Australia/Lord_Howe":"AU","Antarctica/Macquarie":"AU","Australia/Hobart":"AU","Australia/Currie":"AU","Australia/Melbourne":"AU","Australia/Sydney":"AU","Australia/Broken_Hill":"AU","Australia/Brisbane":"AU","Australia/Lindeman":"AU","Australia/Adelaide":"AU","Australia/Darwin":"AU","Australia/Perth":"AU","Australia/Eucla":"AU","Europe/Brussels":"BE","America/St_Johns":"CA","America/Halifax":"CA","America/Glace_Bay":"CA","America/Moncton":"CA","America/Goose_Bay":"CA","America/Blanc-Sablon":"CA","America/Toronto":"CA","America/Nipigon":"CA","America/Thunder_Bay":"CA","America/Iqaluit":"CA","America/Pangnirtung":"CA","America/Resolute":"CA","America/Atikokan":"CA","America/Rankin_Inlet":"CA","America/Winnipeg":"CA","America/Rainy_River":"CA","America/Regina":"CA","America/Swift_Current":"CA","America/Edmonton":"CA","America/Cambridge_Bay":"CA","America/Yellowknife":"CA","America/Inuvik":"CA","America/Creston":"CA","America/Dawson_Creek":"CA","America/Vancouver":"CA","America/Whitehorse":"CA","America/Dawson":"CA","Europe/Zurich":"CH","Europe/Prague":"CZ","Europe/Berlin":"DE","Europe/Busingen":"DE","Europe/Copenhagen":"DK","Europe/Madrid":"ES","Africa/Ceuta":"ES","Atlantic/Canary":"ES","Europe/Helsinki":"FI","Europe/Paris":"FR","Europe/Budapest":"HU","Europe/Rome":"IT","America/Mexico_City":"MX","America/Cancun":"MX","America/Merida":"MX","America/Monterrey":"MX","America/Matamoros":"MX","America/Mazatlan":"MX","America/Chihuahua":"MX","America/Ojinaga":"MX","America/Hermosillo":"MX","America/Tijuana":"MX","America/Santa_Isabel":"MX","America/Bahia_Banderas":"MX","Europe/Amsterdam":"NL","Arctic/Longyearbyen":"NO","Europe/Oslo":"NO","Europe/Warsaw":"PL","Europe/Lisbon":"PT","Atlantic/Madeira":"PT","Atlantic/Azores":"PT","Europe/Stockholm":"SE","Europe/Bratislava":"SK"},r="klarnaosm_user_locale";class o{static getCountryFromTimeZone(){var e;const{timeZone:a}=Intl.DateTimeFormat().resolvedOptions(),n=null!==(e=i[a])&&void 0!==e?e:null;return n||t("[getCountryFromTimeZone] unsupported country or time zone",{timeZone:a}),n}static async getUsersCountry(){let e=o.getCachedUsersCountry();if(e)return t("Found users country in cache"),e;try{const t=new AbortController;setTimeout((()=>t.abort()),1500);const a=window.location.hostname,i=Shopify.shop,r=a!==i?a:"",o=new URL(n.GEOSERVICE_URL);o.searchParams.set("defaultDomain",i),o.searchParams.set("customDomain",r);const s=await fetch(o,{signal:t.signal});if(!s.ok)throw new Error(s.statusText);e=(await s.json()).country}catch(e){return t("[getUsersCountry] Failed",e),t("[getUsersCountry] trying to parse from time zone"),this.getCountryFromTimeZone()}return e&&o.setCachedUsersCountry(e),e}static getCachedUsersCountry(){return localStorage.getItem(r)||null}static setCachedUsersCountry(e){t("Setting users country to cache",e),localStorage.setItem(r,e)}constructor(t){this.midLocales=t}static findLocale(e,a,n){var i,r;if(e){t("[getMatchingLocale] Valid locales for users country",e);const o=null!==(i=e[0])&&void 0!==i?i:null;let s="";if(a&&"undefined"!=typeof Shopify?(s=Shopify.locale,t("[getMatchingLocale] Using Shopify.locale",s)):navigator.language&&(s=navigator.language.slice(0,2),t("[getMatchingLocale] Using browser language",s)),s){const t=e.find((t=>t.startsWith(s)));if(t)return t}return n&&null!==(r=e.find((t=>t.startsWith("en"))))&&void 0!==r?r:o}return null}getMatchingLocale(e,a,n){if(!e||!this.midLocales)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;t("[getMatchingLocale] Available countries for merchant",n);const i=this.getFilteredLocales(n);t("[getMatchingLocale] Valid locales for merchant",i);const r=null==i?void 0:i[e];return o.findLocale(r,a,!0)}getFilteredLocales(t){if(!t)return this.midLocales;const e=new Set(t);return Object.keys(this.midLocales).reduce(((t,a)=>(e.has(a)&&(t[a]=this.midLocales[a]),t)),{})}getMatchingLocaleWithMidLocales(e,a){if(!e||!this.midLocales||0===Object.keys(this.midLocales).length)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;const n=this.midLocales[e];return o.findLocale(n,a,!1)}}const s=o;class c{constructor(t){this.store=t}inject(){if(!this.isOSMScriptAlreadyInjected())try{this.injectKlarnaOSMScriptTag(),t("Klarna OSM Script Tag has been added successfully")}catch(e){t("Could not add script element",e)}}isOSMScriptAlreadyInjected(){return null!==document.getElementById("klarna-osm-script-tag")}logIfEmptyClientId(){this.store.client_id||t("Creating OSM script element without data-client-id. This will cause placements not to show up. Check your configuration of Klarna OSM on the Klarna Merchant Portal.")}injectKlarnaOSMScriptTag(){const t=this.createKlarnaOSMScriptTag(),e=document.querySelector("body");e.insertBefore(t,e.children[0])}createKlarnaOSMScriptTag(){this.logIfEmptyClientId();const t=document.createElement("script"),e=this.store.playground_active?"playground":"production";return t.id="klarna-osm-script-tag",t.async=!0,t.setAttribute("data-environment",e),t.src="https://js.klarna.com/web-sdk/v1/klarna.js",t.setAttribute("data-client-id",this.store.client_id),t}}class l{static getVariantIdFromQueryString(){const t=new URLSearchParams(window.location.search).get("variant");return t?Number.parseInt(t,10):null}constructor(t,e){this.store=t,this.productVariants=e,this.conflictingAppIds=[],this.eventHandler=()=>{this.updatePlacements()},this.localeService=new s(t.mid_locales)}async init(){var t;window.klarna_OSMP=window.klarna_OSMP||{},window.klarna_OSMP.updaterId=null!==(t=window.klarna_OSMP.updaterId)&&void 0!==t?t:0,window.klarna_OSMP.rerenders=new Array(this.calculateRerendersLenBasedOnPlacementsCount()),this.conflictingAppIds=["tmenu-app"].filter((t=>!!document.getElementById(t))),this.logIfConflictingAppsDetected(),this.injectOnSiteScript(),await this.initPurchaseAmountIfCartOrProductPage(),this.listenForInputChange()}calculateRerendersLenBasedOnPlacementsCount(){var t,e,a;return 5+2*(null!==(a=null===(e=null===(t=window.klarna_OSMP)||void 0===t?void 0:t.placements)||void 0===e?void 0:e.filter((t=>t.placement_page===this.currentPageType)).length)&&void 0!==a?a:0)}logIfConflictingAppsDetected(){this.conflictingAppIds.length>0&&t(`Detected apps conflicting with Klarna placements: ${this.conflictingAppIds.join(", ")}. It may cause unwanted behaviour.`)}injectOnSiteScript(){new c(this.store).inject()}async initPurchaseAmountIfCartOrProductPage(){["cart","product"].includes(this.currentPageType)&&await this.updatePurchaseAmount()}listenForInputChange(){"cart"===this.currentPageType&&(0!==this.conflictingAppIds.length?this.updatePlacementsOnInputEvents():this.updatePlacementsOnDomMutations()),"product"===this.currentPageType&&new MutationObserver((e=>{this.getKlarnaPlacements().forEach((e=>{const a=String(this.getDataPurchaseAmount()||0),n=e.getAttribute("data-purchase-amount");a!==e.getAttribute("data-purchase-amount")&&(t(`amount changed to ${a} from ${n}`),e.setAttribute("data-purchase-amount",a))}))})).observe(document.body,{childList:!0,subtree:!0})}updatePlacementsOnDomMutations(){const a=new MutationObserver((async n=>{window.klarna_OSMP.updaterId+=1;const i=window.klarna_OSMP.updaterId,r=[void 0,void 0,await this.getCartTotal()];let o=5;if(l.addCurrentTimeToRerenders(),l.calculateMaxTimeBetweenRerenders()<1e3)return t("Detected too frequent placement rerenders based on DOM modifications. Switching logic to input related one."),o=-1,a.disconnect(),void this.updatePlacementsOnInputEvents();const s=async()=>{const e=await this.getCartTotal();return t("Comparing amount and history",e,r),!!r.some((t=>t!==e))&&(this.updatePurchaseAmount(e),r.shift(),r.push(e),!0)};for(;o>0&&i===window.klarna_OSMP.updaterId;)o-=1,await e(1e3),await s()}));a.observe(document.body,{childList:!0,subtree:!0})}static addCurrentTimeToRerenders(){const{rerenders:t}=window.klarna_OSMP;t.shift(),t.push(new Date)}static calculateMaxTimeBetweenRerenders(){var t,e;const{rerenders:a}=window.klarna_OSMP;return((null===(t=a[a.length-1])||void 0===t?void 0:t.getTime())||1/0)-((null===(e=a[0])||void 0===e?void 0:e.getTime())||-1/0)}updatePlacementsOnInputEvents(){document.querySelectorAll("select, input").forEach((t=>{t.removeEventListener("change",this.eventHandler,!0),t.addEventListener("change",this.eventHandler,!0)}))}async updatePlacements(){await e(20),window.klarna_OSMP.updaterId+=1;const a=window.klarna_OSMP.updaterId;t("Updater started with id",a);let n=await this.getCartTotal();const i=async t=>{await e(t);const a=await this.getCartTotal();return a!==n&&(this.updatePurchaseAmount(a),n=a,!0)};for(;;){let e=10,n=50;for(;e&&!(a<window.klarna_OSMP.updaterId)&&!await i(n);)n*=1.5,e-=1;if(a<window.klarna_OSMP.updaterId){t("Updater terminated due to new one running",a);break}if(!await i(1e3))break}this.updatePlacementsOnInputEvents()}async updatePurchaseAmount(e=""){const a=this.getKlarnaPlacements();let n=e;n||("cart"===this.currentPageType?n=await this.getCartTotal():"product"===this.currentPageType&&(n=this.getDataPurchaseAmount())),t("Updating purchase amount",n),a.forEach((e=>{t("updating placement",e),e.setAttribute("data-purchase-amount",String(n))})),0!==this.conflictingAppIds.length&&this.listenForInputChange()}async getCartTotal(){const t=await fetch("/cart.json");if(!t.ok)throw new Error;const e=await t.json();return e.total_price?e.total_price:0}}class u extends l{constructor(t,e){super(t,e.productVariants),this.data=e,this.currentPageType=e.templateName}async init(){var e,a;const n=this.getKlarnaPlacement();n.setAttribute("data-locale",await this.fetchLocale()),n.setAttribute("data-purchase-amount",this.getPurchaseAmount()),"product"===this.currentPageType&&"0"===this.getPurchaseAmount()&&(null===(e=this.store.dynamic_placements)||void 0===e?void 0:e.includes(n.getAttribute("data-key")||""))&&(t("[AppBlocksInject] using fallback placement",this.store.fallback_placement),n.setAttribute("data-key",this.store.fallback_placement)),n.setAttribute("data-preloaded","true");const i=Number.isNaN(this.data.topPadding)?0:this.data.topPadding,r=Number.isNaN(this.data.bottomPadding)?0:this.data.bottomPadding;return(+i>0||+r>0)&&(null===(a=document.getElementById(`shopify-block-${this.data.selector.slice(12)}`))||void 0===a||a.setAttribute("style",`padding: ${i}px 0px ${r}px 0px;`)),super.init()}getPurchaseAmount(){var t;return"product"===this.currentPageType?this.data.variantPrice:"cart"===this.currentPageType?this.data.cartPrice:(null===(t=window.Shopify)||void 0===t?void 0:t.designMode)?"10998":"0"}async fetchLocale(){var e,a,n,i,r;if((null===(e=window.Shopify)||void 0===e?void 0:e.designMode)&&this.data.localeFallback)return t("[fetchLocale] using manual locale in design mode",this.data),this.data.localeFallback.trim();if(null===(a=window.Shopify)||void 0===a?void 0:a.designMode){const e=null===(n=this.store.mid_locales)||void 0===n?void 0:n[null===Shopify||void 0===Shopify?void 0:Shopify.country],a=e?[e]:Object.values(this.store.mid_locales);let o=null!==(r=null===(i=a[0])||void 0===i?void 0:i[0])&&void 0!==r?r:null;for(const e of a)for(const a of e)if(a.startsWith(this.data.shopLocale)){t("[fetchLocale] using locale for design mode",{locale:a,midLocales:this.store.mid_locales}),o=a;break}return o}if("manual"===this.data.localeOption&&this.data.localeFallback)return t("[fetchLocale] using manual locale"),this.data.localeFallback.trim();if("geolocation"===this.data.localeOption){t("[fetchLocale] using geolocation");const e=await s.getUsersCountry(),a=this.localeService.getMatchingLocaleWithMidLocales(e,!0);return t("got matching locale",{usersCountry:e,matchingLocale:a,midLocales:this.store.mid_locales}),a}return null}getDataPurchaseAmount(){var t,e,a,n,i,r,o,s;let c=null;const u=l.getVariantIdFromQueryString();return u&&(c=null===(t=this.productVariants)||void 0===t?void 0:t.find((t=>t.id===u))),c?c.price:null!==(s=null!==(i=null===(n=null===(a=null===(e=this.productVariants)||void 0===e?void 0:e.filter((t=>t.available)))||void 0===a?void 0:a[0])||void 0===n?void 0:n.price)&&void 0!==i?i:null===(o=null===(r=this.productVariants)||void 0===r?void 0:r[0])||void 0===o?void 0:o.price)&&void 0!==s?s:0}getKlarnaPlacements(){return[this.getKlarnaPlacement()]}getKlarnaPlacement(){return document.getElementById(this.data.selector)}}class d{static async fetchStore(){var t;if(this.store)return this.store;const e=window.location.hostname,a=null===(t=window.Shopify)||void 0===t?void 0:t.shop,i=e!==a?e:"",r=new URL(("/app-blocks/v1/store",`${n.DEVELOPMENT_PATH_PREFIX}/app-blocks/v1/store`),n.APP_URL);r.searchParams.set("defaultDomain",a),r.searchParams.set("customDomain",i);const o=await fetch(r.toString());return this.store=await o.json(),this.store}async push(t){await new u(await d.fetchStore(),t).init()}}t("app blocks loaded"),window.Klarna=window.Klarna||{},window.klarnaAppBlocksManager=new d})()})();